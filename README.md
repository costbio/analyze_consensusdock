# Consensus Docking Analysis Workflow

This repository contains scripts for running batch consensus docking experiments using AlphaFold structures and cavity data.

## Workflow Overview

The docking workflow consists of three main steps:

1. **UniProt Mapping Generation** (`prepare_uniprot_mapping.py`)
2. **Cavity Extraction** (`extract_cavities.py`) - **NEW SEPARATE STEP**
3. **Batch Docking Execution** (`batch_dock.py`)

## Scripts

### 1. prepare_uniprot_mapping.py
Generates UniProt ID to gene name mappings required for the docking workflow.

**Output**: `uniprot_gene_mapping.csv`

### 2. extract_cavities.py ⭐ **NEW**
Extracts receptor and cavity PDB files from AlphaFold cavity tarballs. This is now a separate preprocessing step that can take significant time but only needs to be run once.

**Features**:
- Handles multiple cavities per protein (cavity_1, cavity_2, etc.)
- Creates mapping CSV for fast loading by main docking script
- Extracts files to `extracted_cavities/` folder in current working directory
- Can resume from existing extractions

**Configuration**: Edit the `CAVITY_TARBALL_FOLDER` path in the script

**Usage**:
```bash
python extract_cavities.py
```

**Output**: 
- `cavity_mapping.csv` - Mapping file for main docking script
- `extracted_cavities/` - Directory with extracted PDB files
- `cavity_extraction.log` - Extraction log

### 3. batch_dock.py
Main docking execution script that uses pre-generated mappings to run consensus docking jobs.

**Features**:
- Uses pre-extracted cavity mappings (faster startup)
- Supports multiple cavities per protein
- Test mode for validation
- Resume capability (skips completed jobs)

**Prerequisites**:
- `uniprot_gene_mapping.csv` (from step 1)
- `cavity_mapping.csv` (from step 2)

**Usage**:
```bash
python batch_dock.py
```

**Output**:
- `consensus_docking_results/` - Docking results
- `docking_automation.log` - Docking log

## Key Improvements

### Multiple Cavity Support
Both `extract_cavities.py` and `batch_dock.py` now handle multiple cavities per protein:
- Detects `_vacant_1.pdb`, `_vacant_2.pdb`, etc.
- Detects `_cavity_1.pdb`, `_cavity_2.pdb`, etc.
- Creates separate docking jobs for each cavity

### Separated Extraction Process
- Cavity extraction is now a separate step that can be run independently
- Extraction results are cached, so the main docking script starts faster
- Large extraction process doesn't need to be repeated for multiple docking runs

### Working Directory Fix
- `extracted_cavities/` folder is now created in the current working directory (where scripts are called from)
- No longer creates folders in the script's installation directory

## Recommended Workflow

```bash
# Step 1: Generate UniProt mappings (if not already done)
python prepare_uniprot_mapping.py

# Step 2: Extract cavities (new separate step - can take a while)
python extract_cavities.py

# Step 3: Run batch docking (now starts faster)
python batch_dock.py
```

## Configuration

Before running the scripts, update the configuration paths in each script:

- **extract_cavities.py**: `CAVITY_TARBALL_FOLDER`
- **batch_dock.py**: `CONSENSUS_DOCKER_SCRIPT`, `PROCESSED_LIGAND_SDF_FOLDER`, `DRUG_TO_PROTEIN_TSV`

## File Organization

```
your_working_directory/
├── prepare_uniprot_mapping.py
├── extract_cavities.py
├── batch_dock.py
├── uniprot_gene_mapping.csv          # Generated by step 1
├── cavity_mapping.csv                # Generated by step 2
├── extracted_cavities/               # Generated by step 2
│   ├── AF-P12345-F1-model_v1/
│   │   ├── ...vacant_1.pdb
│   │   ├── ...cavity_1.pdb
│   │   ├── ...vacant_2.pdb
│   │   └── ...cavity_2.pdb
│   └── ...
├── consensus_docking_results/        # Generated by step 3
│   ├── DB00001_GENE1_P12345_cavity_1/
│   ├── DB00001_GENE1_P12345_cavity_2/
│   └── ...
├── cavity_extraction.log
└── docking_automation.log
```

## Notes

- Run `extract_cavities.py` in test mode first to verify your cavity tarball folder is correct
- The extraction step only needs to be run once unless you get new cavity data
- Use TEST_MODE=True in `batch_dock.py` to validate your setup before running full batch
- Both scripts support resumption - they will skip work that's already been completed
